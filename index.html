<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrezAI ‚Äî –í–®–ë</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PptxGenJS/3.12.0/pptxgen.bundle.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700;900&family=Geologica:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f4fbf9;          /* –æ–±—â–∏–π —Ñ–æ–Ω */
  --s1: #ffffff;          /* –∫–∞—Ä—Ç–æ—á–∫–∏ */
  --s2: #eef7f4;          /* –ø–æ–ª—è –∏–Ω–ø—É—Ç–æ–≤ */
  --border: #d6ebe4;      /* –≥—Ä–∞–Ω–∏—Ü—ã */

  --blue: #1aa39a;        /* –æ—Å–Ω–æ–≤–Ω–æ–π mint */
  --blue2: #148a82;       /* hover / –∞–∫—Ü–µ–Ω—Ç */
  --gold: #34c7b6;        /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç */

  --text: #1f2d2a;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
  --muted: #6f8f88;       /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç */
  --green: #20bfae;       /* —É—Å–ø–µ—Ö */

  --r: 14px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Geologica', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 800px 600px at 10% 0%, rgba(0,48,135,0.22) 0%, transparent 55%),
    radial-gradient(ellipse 400px 400px at 90% 90%, rgba(240,192,64,0.06) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}

.app {
  position: relative; z-index: 1;
  max-width: 860px;
  margin: 0 auto;
  padding: 32px 24px 100px;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 52px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
}

.vshb-logo {
  width: 48px;
  height: 48px;
  object-fit: contain;
}

.logo-wordmark {
  display: flex;
  flex-direction: column;
  gap: 1px;
}
.logo-top {
  font-family: 'Unbounded', sans-serif;
  font-weight: 900;
  font-size: 17px;
  letter-spacing: -0.5px;
  color: var(--text);
  line-height: 1;
}
.logo-top span { color: var(--gold); }
.logo-sub {
  font-size: 10px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: 1.5px;
  text-transform: uppercase;
}

.header-right { display: flex; align-items: center; gap: 10px; }

.pill {
  font-size: 11px;
  font-weight: 600;
  color: var(--gold);
  background: rgba(240,192,64,0.08);
  border: 1px solid rgba(240,192,64,0.2);
  padding: 5px 13px;
  border-radius: 20px;
  letter-spacing: 0.8px;
  text-transform: uppercase;
}

.conn {
  display: flex; align-items: center; gap: 6px;
  font-size: 11px; color: var(--muted);
}
.dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); }
.dot.on { background: var(--green); box-shadow: 0 0 7px rgba(0,201,138,0.5); }

/* ‚îÄ‚îÄ Hero ‚îÄ‚îÄ */
.hero { margin-bottom: 40px; }
.hero h1 {
  font-family: 'Unbounded', sans-serif;
  font-weight: 900;
  font-size: clamp(26px, 4vw, 44px);
  line-height: 1.08;
  letter-spacing: -2px;
  margin-bottom: 12px;
}
.hero h1 em { font-style: normal; color: var(--gold); }
.hero p { color: var(--muted); font-size: 15px; font-weight: 300; line-height: 1.7; max-width: 500px; }


.banner {
  display: flex; align-items: center; gap: 12px;
  background: rgba(0,48,135,0.14);
  border: 1px solid rgba(0,80,200,0.22);
  border-radius: var(--r);
  padding: 12px 18px;
  margin-bottom: 24px;
  font-size: 12.5px;
  color: #7a9ed8;
}
.banner strong { color: white; }
.banner code {
  background: rgba(0,80,200,0.18);
  color: var(--gold);
  padding: 2px 7px; border-radius: 5px;
  font-family: 'Consolas', monospace; font-size: 11.5px;
}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.card::after {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(0,80,200,0.35), transparent);
}

.slabel {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 2px;
  color: #4a7ac0;
  margin-bottom: 22px;
  display: flex; align-items: center; gap: 8px;
}
.slabel::before {
  content: ''; display: block;
  width: 3px; height: 13px;
  background: var(--gold); border-radius: 2px;
}

label {
  display: block; font-size: 12.5px; font-weight: 500;
  color: #8090b0; margin-bottom: 7px;
}

input[type="text"], input[type="password"], textarea, select {
  width: 100%;
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Geologica', sans-serif;
  font-size: 14px;
  padding: 12px 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  resize: none;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--blue2);
  box-shadow: 0 0 0 3px rgba(0,80,200,0.12);
}
input::placeholder, textarea::placeholder { color: #2a3555; }
select option { background: #131829; }

.field { margin-bottom: 18px; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

.hint { font-size: 11px; color: #2e3d60; margin-top: 5px; }
.hint a { color: var(--blue2); text-decoration: none; }

/* ‚îÄ‚îÄ Auth tabs ‚îÄ‚îÄ */
.atabs { display: flex; gap: 6px; margin-bottom: 16px; }
.atab {
  padding: 6px 15px;
  border-radius: 8px; border: 1px solid var(--border);
  background: transparent; color: var(--muted);
  font-family: 'Geologica', sans-serif;
  font-size: 12px; font-weight: 500; cursor: pointer;
  transition: all 0.15s;
}
.atab:hover { border-color: var(--blue2); color: #7aabee; }
.atab.on { background: rgba(0,48,135,0.2); border-color: var(--blue2); color: #7aabee; }

/* ‚îÄ‚îÄ Chips ‚îÄ‚îÄ */
.chips { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 7px;  }
.chip {
  padding: 7px 14px; border-radius: 8px;
  border: 1px solid var(--border);
  background: transparent; color: var(--muted);
  font-family: 'Geologica', sans-serif;
  font-size: 12.5px; font-weight: 500; cursor: pointer;
  transition: all 0.15s;
}
.chip:hover { border-color: var(--blue2); color: #7aabee; }
.chip.on {
  background: rgba(0,48,135,0.2);
  border-color: var(--blue2); color: #7aabee;
}

/* ‚îÄ‚îÄ Theme chips ‚îÄ‚îÄ */
.theme-chip {
  display: flex; align-items: center; gap: 8px;
  padding: 7px 14px; border-radius: 9px;
  border: 1px solid var(--border);
  background: transparent; color: var(--muted);
  font-family: 'Geologica', sans-serif;
  font-size: 12.5px; font-weight: 500; cursor: pointer;
  transition: all 0.15s;
}
.theme-chip:hover { border-color: var(--blue2); color: var(--text); }
.theme-chip.on { border-color: var(--blue2); color: var(--text); background: rgba(0,48,135,0.15); }
.theme-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

/* ‚îÄ‚îÄ Range ‚îÄ‚îÄ */
input[type="range"] { width: 100%; accent-color: var(--blue2); margin-top: 6px; }
.rl { display: flex; justify-content: space-between; font-size: 10.5px; color: var(--muted); margin-top: 3px; }

/* ‚îÄ‚îÄ Advanced toggle ‚îÄ‚îÄ */
.adv-btn {
  font-size: 12px; color: var(--muted); cursor: pointer;
  display: flex; align-items: center; gap: 6px;
  padding: 6px 0; background: none; border: none;
  font-family: 'Geologica', sans-serif;
  transition: color 0.15s;
}
.adv-btn:hover { color: #7aabee; }
.adv-section { display: none; padding-top: 14px; }
.adv-section.open { display: block; }

/* ‚îÄ‚îÄ Arch ‚îÄ‚îÄ */
.arch-btn {
  width: 100%; text-align: left;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 10px; padding: 11px 16px;
  font-family: 'Geologica', sans-serif;
  font-size: 12.5px; color: var(--muted); cursor: pointer;
  transition: all 0.2s; display: flex; align-items: center; gap: 8px;
}
.arch-btn:hover { border-color: var(--blue2); color: var(--text); }
.arch-panel {
  display: none; margin-top: 10px;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 10px; padding: 18px;
  font-size: 12px; color: var(--muted); line-height: 1.7;
}
.arch-panel.open { display: block; }
.arch-panel code {
  background: rgba(0,80,200,0.15); color: var(--gold);
  padding: 1px 6px; border-radius: 4px;
  font-family: 'Consolas', monospace; font-size: 11px;
}
.flow { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin: 10px 0; font-size: 11px; }
.fstep {
  background: var(--s1); border: 1px solid var(--border);
  padding: 5px 11px; border-radius: 7px;
  color: var(--text); font-weight: 500;
}
.farr { color: var(--gold); font-size: 13px; }
.pprev {
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 8px; padding: 12px 14px;
  font-family: 'Consolas', monospace; font-size: 11px;
  color: #5a7090; margin-top: 8px;
  white-space: pre-wrap; max-height: 180px; overflow-y: auto;
}

/* ‚îÄ‚îÄ Generate button ‚îÄ‚îÄ */
.btn-gen {
  width: 100%; padding: 18px;
  background: linear-gradient(135deg, #002a70 0%, #003cb0 50%, #0050d0 100%);
  border: none; border-radius: var(--r);
  color: white;
  font-family: 'Unbounded', sans-serif;
  font-weight: 700; font-size: 15px;
  letter-spacing: 0.3px; cursor: pointer;
  transition: all 0.3s; margin-top: 4px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.btn-gen:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 36px rgba(0,48,135,0.55);
}
.btn-gen:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* ‚îÄ‚îÄ Status ‚îÄ‚îÄ */
.status-card {
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px 28px;
  display: none; margin-bottom: 16px;
}
.status-card.open { display: block; }
.shead { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.spinner {
  width: 20px; height: 20px;
  border: 2.5px solid rgba(0,80,200,0.15);
  border-top-color: var(--blue2);
  border-radius: 50%;
  animation: spin 0.8s linear infinite; flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }
.shead-title { font-weight: 600; font-size: 14px; }
.pbar { height: 3px; background: var(--s2); border-radius: 2px; overflow: hidden; margin-bottom: 12px; }
.pfill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--blue2), var(--gold));
  border-radius: 2px; transition: width 0.5s ease; width: 0%;
}
.logbox {
  font-size: 11.5px; color: var(--muted);
  font-family: 'Consolas', monospace; line-height: 1.6;
  max-height: 90px; overflow-y: auto;
}
.ll.active { color: #7aabee; }
.ll.done { color: var(--green); }
.ll.err { color: #e74c3c; }

/* ‚îÄ‚îÄ Result ‚îÄ‚îÄ */
.result-card {
  background: linear-gradient(135deg, rgba(0,48,135,0.1), rgba(240,192,64,0.04));
  border: 1px solid rgba(0,80,200,0.2);
  border-radius: 20px; padding: 28px;
  display: none; text-align: center; margin-bottom: 16px;
}
.result-card.open { display: block; }
.result-icon { font-size: 42px; margin-bottom: 12px; }
.result-card h3 {
  font-family: 'Unbounded', sans-serif;
  font-weight: 700; font-size: 19px; margin-bottom: 7px;
}
.result-card p { color: var(--muted); font-size: 13px; margin-bottom: 22px; }

.btn-dl {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 12px 26px;
  background: var(--green); border: none; border-radius: 10px;
  color: white;
  font-family: 'Unbounded', sans-serif;
  font-weight: 700; font-size: 13px; cursor: pointer;
  transition: all 0.2s; margin-right: 10px;
}
.btn-dl:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,201,138,0.3); }

.btn-reset {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 12px 20px;
  background: var(--s2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--muted);
  font-family: 'Geologica', sans-serif;
  font-size: 13px; cursor: pointer; transition: all 0.2s;
}
.btn-reset:hover { color: var(--text); border-color: var(--muted); }

.thumbs { display: flex; flex-wrap: wrap; gap: 7px; justify-content: center; margin-top: 20px; }
.thumb {
  width: 78px; height: 49px; border-radius: 5px;
  overflow: hidden; border: 1.5px solid var(--border);
  font-size: 6px; display: flex; flex-direction: column;
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 20px; right: 20px;
  background: #180e0e; border: 1px solid rgba(231,76,60,0.3);
  border-radius: 10px; padding: 12px 18px;
  font-size: 13px; color: #e74c3c;
  max-width: 340px; z-index: 1000; display: none;
}
.toast.open { display: block; animation: sup 0.3s ease; }
@keyframes sup { from { transform: translateY(14px); opacity: 0; } to { transform: none; opacity: 1; } }

@media (max-width: 580px) {
  .grid2 { grid-template-columns: 1fr; }
  .hero h1 { font-size: 24px; }
  .card { padding: 18px; }
}
</style>
</head>
<body>
<div class="app">

<header>
  <div class="logo">
  <img 
    src="https://upload.wikimedia.org/wikipedia/ru/d/d6/–õ–æ–≥–æ—Ç–∏–ø_–ù–ò–£_–í–®–≠.jpg" 
    class="vshb-logo"
    alt="–ù–ò–£ –í–®–≠">
</a>
</a>
      <!-- –§–æ–Ω -->
      <rect width="48" height="48" rx="10" fill="#003087"/>
      <!-- –ë—É–∫–≤–∞ –® —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è -->
      <rect x="8" y="10" width="5" height="28" rx="1.5" fill="white"/>
      <rect x="21.5" y="10" width="5" height="28" rx="1.5" fill="white"/>
      <rect x="35" y="10" width="5" height="28" rx="1.5" fill="white"/>
      <rect x="8" y="31" width="32" height="5" rx="1.5" fill="white"/>
      <!-- –ó–æ–ª–æ—Ç–∞—è —Ç–æ—á–∫–∞-–∞–∫—Ü–µ–Ω—Ç -->
      <circle cx="40" cy="10" r="4" fill="#f0c040"/>
    </svg>
    <div class="logo-wordmark">
      <div class="logo-top">Prez<span>AI</span></div>
      <div class="logo-sub">–í—ã—Å—à–∞—è —à–∫–æ–ª–∞ –±–∏–∑–Ω–µ—Å–∞ ¬∑ –ù–ò–£ –í–®–≠</div>
    </div>
  </div>
  <div class="header-right">
    
    <span class="pill">Track 1</span>
  </div>
</header>
<!-- REQUIRED hidden fields for existing JS (do not remove) -->
<input type="hidden" id="apiUrl" value="/api/chat">
<input type="hidden" id="tempRange" value="0.7">
<input type="hidden" id="maxTokens" value="8000">


<div class="hero">
  <h1>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è<br>–∑–∞ <em>–ø–∞—Ä—É –º–∏–Ω—É—Ç</em> ‚ú¶</h1>
  <p>–¢–µ–º–∞ ‚Üí PPTX. –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, –±–µ–∑ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä—è–º–æ —á–µ—Ä–µ–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –í–®–ë.</p>
</div>



<!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
<div class="card">
  <div class="slabel">–ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</div>

  <div class="field">
    <label>üìå –¢–µ–º–∞</label>
    <input type="text" id="topic" placeholder="–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±–∞–Ω–∫–∞ 2025‚Äì2027">
  </div>
  <div class="field">
    <label>üéØ –ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
    <input type="text" id="audience" placeholder="–ó–∞—â–∏—Ç–∞ –ø–µ—Ä–µ–¥ –∫–æ–º–∏—Å—Å–∏–µ–π –í–®–ë, –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º–∏, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º">
  </div>
  <div class="field">
    <label>üìù –ß—Ç–æ –≤–∫–ª—é—á–∏—Ç—å / –∏—Å–∫–ª—é—á–∏—Ç—å</label>
    <textarea id="requirements" rows="3" placeholder="–í–∫–ª—é—á–∏—Ç—å: –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞, ROI, –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É. –ò—Å–∫–ª—é—á–∏—Ç—å: —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏."></textarea>
  </div>

  <div class="field">
    <label>üìä –°–ª–∞–π–¥–æ–≤: <strong id="slidesVal">10</strong></label>
    <input type="range" id="slidesCount" min="5" max="20" value="10"
      oninput="document.getElementById('slidesVal').textContent=this.value">
    <div class="rl"><span>5</span><span>20</span></div>
  </div>

  <div class="field">
    <label>‚ú® –¢–æ–Ω</label>
    <div class="chips" id="toneChips">
      <button class="chip on" data-val="professional">–î–µ–ª–æ–≤–æ–π</button>
      <button class="chip" data-val="minimalist">–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π</button>
      <button class="chip" data-val="friendly">–õ—ë–≥–∫–∏–π –∏ –∂–∏–≤–æ–π</button>
      <button class="chip" data-val="friendly">Axenix </button>
      <button class="chip" data-val="friendly">–í–®–ë</button>
    </div>
  </div>

  <div class="field" style="margin-bottom:0">
    <label>üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
    <div class="chips" id="themeChips">
      <button class="theme-chip on" data-val="hse_dark">
        <div class="theme-dot" style="background:#0d1e38;border:1px solid #3a7cc7"></div>
        –¢—ë–º–Ω–∞—è
      </button>
      <button class="theme-chip" data-val="hse_light">
        <div class="theme-dot" style="background:#ffffff;border:1px solid #003f8a"></div>
        –°–≤–µ—Ç–ª–∞—è
      </button>
    </div>
  </div>
</div>



<button class="btn-gen" id="genBtn" onclick="generate()">
  <span>‚ñ∂</span>
  <span id="genBtnText">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é</span>
</button>

<div class="status-card" id="statusCard">
  <div class="shead">
    <div class="spinner"></div>
    <div class="shead-title" id="statusTitle">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶</div>
  </div>
  <div class="pbar"><div class="pfill" id="pfill"></div></div>
  <div class="logbox" id="logbox"></div>
</div>

<div class="result-card" id="resultCard">
  <div class="result-icon">üéì</div>
  <h3 id="resTitle">–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞!</h3>
  <p id="resMeta">‚Äî —Å–ª–∞–π–¥–æ–≤ ¬∑ PPTX</p>
  <div>
    <button class="btn-dl" id="dlBtn">‚¨á –°–∫–∞—á–∞—Ç—å PPTX</button>
    <button class="btn-reset" onclick="doReset()">‚Ü© –ù–æ–≤–∞—è</button>
  </div>
  <div class="thumbs" id="thumbs"></div>
</div>

</div>
<div class="toast" id="toast"></div>
<!-- Popup: generating -->
<div id="genOverlay" style="
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background: rgba(0,0,0,.55); backdrop-filter: blur(8px);
  z-index:9999;
">
  <div style="
    width: 420px; max-width: calc(100vw - 40px);
    background: #0c0f1a; border: 1px solid #1e2540; border-radius: 16px;
    padding: 18px 18px 16px; color:#e8edf8;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
  ">
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
      <div style="
        width: 18px; height: 18px;
        border: 2.5px solid rgba(0,80,200,0.18);
        border-top-color: #0050c8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      "></div>
      <div style="font-weight:600;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏‚Ä¶</div>
    </div>
    <div style="font-size:12px; color:#5a6a8a; line-height:1.55;">
      –°–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–ª—é –∑–∞–ø—Ä–æ—Å –≤ backend, –ø–æ–ª—É—á—É PPTX –∏ –≤–µ—Ä–Ω—É —Ç–µ–±–µ —Ñ–∞–π–ª.
    </div>

    <div style="display:flex; justify-content:flex-end; margin-top:14px;">
      <button id="genOverlayClose" style="
        padding: 9px 12px;
        background: transparent; border: 1px solid #1e2540;
        border-radius: 10px; color:#5a6a8a; cursor:pointer;
      ">–°–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let authMode = 'none';
let selTone  = 'professional';
let selTheme = 'hse_dark';
let pptxBlob = null;
let logLines = [];

// ‚îÄ‚îÄ Chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initChips(id, cb) {
  document.querySelectorAll(`#${id} .chip, #${id} .theme-chip`).forEach(c => {
    c.addEventListener('click', () => {
      document.querySelectorAll(`#${id} .chip, #${id} .theme-chip`).forEach(x => x.classList.remove('on'));
      c.classList.add('on'); cb(c.dataset.val);
    });
  });
}
initChips('toneChips',  v => selTone  = v);
initChips('themeChips', v => selTheme = v);

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setAuth(m) {
  authMode = m;
  ['None','Bearer','Basic'].forEach(x =>
    document.getElementById('auth'+x).style.display = (m === x.toLowerCase()) ? '' : 'none'
  );
  document.getElementById('authNone').style.display   = m === 'none'   ? '' : 'none';
  document.getElementById('authBearer').style.display = m === 'bearer' ? '' : 'none';
  document.getElementById('authBasic').style.display  = m === 'basic'  ? '' : 'none';
  ['tabNone','tabBearer','tabBasic'].forEach(id => document.getElementById(id).classList.remove('on'));
  document.getElementById({none:'tabNone',bearer:'tabBearer',basic:'tabBasic'}[m]).classList.add('on');
}

// ‚îÄ‚îÄ Toggles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAdv() {
  const s = document.getElementById('advSection');
  const open = s.classList.toggle('open');
  document.getElementById('advArrow').textContent = open ? '‚ñº' : '‚ñ∂';
}
function toggleArch() {
  document.getElementById('archPanel').classList.toggle('open');
}

// ‚îÄ‚îÄ Connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkConn() {
  const url = document.getElementById('apiUrl').value.replace('/inference/v1/generate','/health');
  try {
    const r = await fetch(url, { method:'GET', signal: AbortSignal.timeout(3000) });
    document.getElementById('connDot').className   = r.ok ? 'dot on' : 'dot';
    document.getElementById('connLabel').textContent = r.ok ? 'API –¥–æ—Å—Ç—É–ø–µ–Ω' : '–æ—à–∏–±–∫–∞ '+r.status;
  } catch { document.getElementById('connDot').className = 'dot'; document.getElementById('connLabel').textContent = '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'; }
}
setTimeout(checkConn, 800);
setInterval(checkConn, 30000);

// ‚îÄ‚îÄ Themes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const THEMES = {
  hse_dark:  { bg:'0a1628', slide:'0d1e38', text:'E8EEF8', accent:'3a7cc7', title_bg:'061020', muted:'5a7a9a' },
  hse_light: { bg:'F5F7FC', slide:'FFFFFF', text:'0a1628', accent:'003f8a', title_bg:'003f8a', muted:'5a7090' }
};

function buildPrompt(opts) {
  const toneDesc = {
    professional: '–¥–µ–ª–æ–≤–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π ‚Äî —á—ë—Ç–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –±–µ–∑ –≤–æ–¥—ã',
    minimalist:   '–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∑–∏—Å—ã, –Ω–∏–∫–∞–∫–∏—Ö –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤',
    friendly:     '–ª—ë–≥–∫–∏–π –∏ –∂–∏–≤–æ–π ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ, —Å —ç–Ω–µ—Ä–≥–∏–µ–π, –Ω–æ –±–µ–∑ –ø–∞–Ω–∏–±—Ä–∞—Ç—Å—Ç–≤–∞'
  };
  return `–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π.
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–º–∞—Å—Å–∏–≤, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ/–ø–æ—Å–ª–µ, –±–µ–∑ \`\`\`.

–¢–µ–º–∞: ${opts.topic}
–ê—É–¥–∏—Ç–æ—Ä–∏—è: ${opts.audience || '–±–∏–∑–Ω–µ—Å-–∞—É–¥–∏—Ç–æ—Ä–∏—è'}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: ${opts.requirements || '–Ω–µ—Ç'}
–Ø–∑—ã–∫: ${opts.language === 'ru' ? '—Ä—É—Å—Å–∫–∏–π' : opts.language === 'en' ? '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π' : '—Ä—É—Å—Å–∫–∏–π + –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã'}
–¢–æ–Ω: ${toneDesc[opts.tone] || toneDesc.professional}
–°–ª–∞–π–¥–æ–≤: ${opts.slides}

–°–•–ï–ú–ê:
{ "type":"title|section|content|twoColumn|bigstat|quote|timeline|closing",
  "title":"...", "subtitle":"...", "body":"...", "bullets":["..."],
  "left":"...", "right":"...", "leftBullets":["..."], "rightBullets":["..."],
  "stat":"...", "statLabel":"...", "quote":"...", "quoteAuthor":"...",
  "timelineItems":[{"year":"...","event":"..."}], "speakerNotes":"..." }

–ü–†–ê–í–ò–õ–ê:
1. –ü–µ—Ä–≤—ã–π ‚Äî title, –ø–æ—Å–ª–µ–¥–Ω–∏–π ‚Äî closing
2. –ú–∏–Ω–∏–º—É–º 1 twoColumn –∏ 1 bigstat
3. bullets ‚â§ 5, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–∑–∏—Å—ã
4. –ó–∞–ø—Ä–µ—â–µ–Ω–æ: –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã, Lorem ipsum, –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
5. –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ ‚Üí "–¥–∞–Ω–Ω—ã–µ —É—Ç–æ—á–Ω—è—é—Ç—Å—è"
6. speakerNotes –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –Ω–∞ –∫–∞–∂–¥–æ–º —Å–ª–∞–π–¥–µ`;
}
function log(msg, type='active') {
  logLines.forEach(el => { if(el.classList.contains('active')) el.classList.replace('active','done'); });
  const d = document.createElement('div');
  d.className = 'll ' + type; d.textContent = '> ' + msg;
  const box = document.getElementById('logbox');
  box.appendChild(d); box.scrollTop = box.scrollHeight;
  logLines.push(d);
}
function progress(p) { document.getElementById('pfill').style.width = p + '%'; }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('open');
  setTimeout(() => t.classList.remove('open'), 6000);
}
function getHeaders() {
  const h = { 'Content-Type': 'application/json' };
  if (authMode === 'bearer') {
    const tok = document.getElementById('bearerToken').value.trim();
    if (tok) h['Authorization'] = 'Bearer ' + tok;
  } else if (authMode === 'basic') {
    const u = document.getElementById('basicUser').value.trim();
    const p = document.getElementById('basicPass').value.trim();
    if (u && p) h['Authorization'] = 'Basic ' + btoa(u+':'+p);
  }
  return h;
}
function parseResp(data) {
  if (data.choices?.[0]) return data.choices[0].message?.content || data.choices[0].text || '';
  if (data.text) return Array.isArray(data.text) ? data.text[0] : data.text;
  if (data.generated_text) return data.generated_text;
  return JSON.stringify(data);
}
async function buildPptx(slides, opts) {
  const T   = THEMES[selTheme] || THEMES.hse_dark;
  const drk = selTheme === 'hse_dark';
  const W = 10, H = 5.625;
  const pres = new PptxGenJS();
  pres.layout = 'LAYOUT_16x9';
  pres.title  = opts.topic;
  pres.author = 'PrezAI –í–®–ë';

  for (let i = 0; i < slides.length; i++) {
    const s  = slides[i];
    const sl = pres.addSlide();

    if (s.type === 'title') {
      sl.background = { color: T.title_bg };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:0.28,h:H, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addShape(pres.ShapeType.rect, { x:0.28,y:2.95,w:W-0.28,h:0.035, fill:{color:'f0c040'}, line:{color:'f0c040'} });
      sl.addText(s.title||opts.topic, { x:0.55,y:1.1,w:8.8,h:1.7, fontSize:36,bold:true,color:'FFFFFF',fontFace:'Calibri',align:'left',valign:'bottom',margin:0 });
      if(s.subtitle) sl.addText(s.subtitle, { x:0.55,y:3.1,w:7,h:0.7, fontSize:17,color:'f0c040',fontFace:'Calibri',align:'left',margin:0 });
      sl.addText(`${i+1}/${slides.length}`, { x:8.6,y:5.2,w:1.2,h:0.3, fontSize:10,color:T.muted,align:'right',margin:0 });

    } else if (s.type === 'section') {
      sl.background = { color: T.title_bg };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.1, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addText(String(i).padStart(2,'0'), { x:0.5,y:0.6,w:2.5,h:1.5, fontSize:80,color:drk?'1a2e50':'DDDDDD',fontFace:'Calibri',bold:true,margin:0 });
      sl.addText(s.title, { x:0.5,y:2.2,w:9,h:1.1, fontSize:30,bold:true,color:'FFFFFF',fontFace:'Calibri',margin:0 });
      if(s.subtitle) sl.addText(s.subtitle, { x:0.5,y:3.4,w:8,h:0.65, fontSize:15,color:'f0c040',fontFace:'Calibri',margin:0 });

    } else if (s.type === 'content') {
      sl.background = { color: T.slide };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.82, fill:{color:T.title_bg}, line:{color:T.title_bg} });
      sl.addShape(pres.ShapeType.rect, { x:0,y:0.82,w:W,h:0.035, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addText(s.title, { x:0.5,y:0.1,w:9,h:0.65, fontSize:21,bold:true,color:'FFFFFF',fontFace:'Calibri',valign:'middle',margin:0 });
      let y = 1.0;
      if(s.body) { sl.addText(s.body, { x:0.5,y,w:9,h:0.58, fontSize:13,color:drk?'8899bb':'888888',fontFace:'Calibri',italic:true,margin:0 }); y+=0.63; }
      if(s.bullets?.length) {
        const items = s.bullets.map((b,j)=>({text:b,options:{bullet:true,breakLine:j<s.bullets.length-1}}));
        sl.addText(items, { x:0.5,y,w:9,h:H-y-0.28, fontSize:14,color:drk?'D8E8FF':T.text,fontFace:'Calibri',valign:'top',paraSpaceAfter:7,margin:0 });
      }

    } else if (s.type === 'twoColumn') {
      sl.background = { color: T.slide };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.82, fill:{color:T.title_bg}, line:{color:T.title_bg} });
      sl.addShape(pres.ShapeType.rect, { x:0,y:0.82,w:W,h:0.035, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addText(s.title, { x:0.5,y:0.1,w:9,h:0.65, fontSize:21,bold:true,color:'FFFFFF',fontFace:'Calibri',margin:0 });
      sl.addShape(pres.ShapeType.rect, { x:4.88,y:1.0,w:0.035,h:4.35, fill:{color:T.accent}, line:{color:T.accent} });
      if(s.left) sl.addText(s.left, { x:0.4,y:1.0,w:4.2,h:0.55, fontSize:15,bold:true,color:'f0c040',fontFace:'Calibri',margin:0 });
      if(s.leftBullets?.length) { const it=s.leftBullets.map((b,j)=>({text:b,options:{bullet:true,breakLine:j<s.leftBullets.length-1}})); sl.addText(it,{x:0.4,y:1.6,w:4.2,h:3.6,fontSize:12,color:drk?'D8E8FF':T.text,fontFace:'Calibri',paraSpaceAfter:5,margin:0}); }
      if(s.right) sl.addText(s.right, { x:5.1,y:1.0,w:4.5,h:0.55, fontSize:15,bold:true,color:'f0c040',fontFace:'Calibri',margin:0 });
      if(s.rightBullets?.length) { const it=s.rightBullets.map((b,j)=>({text:b,options:{bullet:true,breakLine:j<s.rightBullets.length-1}})); sl.addText(it,{x:5.1,y:1.6,w:4.5,h:3.6,fontSize:12,color:drk?'D8E8FF':T.text,fontFace:'Calibri',paraSpaceAfter:5,margin:0}); }

    } else if (s.type === 'bigstat') {
      sl.background = { color: T.slide };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.82, fill:{color:T.title_bg}, line:{color:T.title_bg} });
      sl.addShape(pres.ShapeType.rect, { x:0,y:0.82,w:W,h:0.035, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addText(s.title, { x:0.5,y:0.1,w:9,h:0.65, fontSize:21,bold:true,color:'FFFFFF',fontFace:'Calibri',margin:0 });
      sl.addText(s.stat||'‚Äî', { x:1,y:1.3,w:8,h:2.0, fontSize:96,bold:true,color:'f0c040',fontFace:'Calibri',align:'center',margin:0 });
      if(s.statLabel) sl.addText(s.statLabel, { x:1,y:3.4,w:8,h:0.7, fontSize:19,color:drk?'AABBCC':T.muted,fontFace:'Calibri',align:'center',margin:0 });
      if(s.body) sl.addText(s.body, { x:1.5,y:4.2,w:7,h:0.65, fontSize:12,color:drk?'667799':T.muted,fontFace:'Calibri',align:'center',italic:true,margin:0 });

    } else if (s.type === 'quote') {
      sl.background = { color: T.title_bg };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:0.32,h:H, fill:{color:'f0c040'}, line:{color:'f0c040'} });
      sl.addText('\u275d', { x:0.65,y:0.35,w:2.5,h:1.5, fontSize:90,color:T.accent,fontFace:'Calibri',align:'left',margin:0 });
      sl.addText(s.quote||s.body||'', { x:0.65,y:1.5,w:9,h:2.6, fontSize:21,italic:true,color:'FFFFFF',fontFace:'Calibri',align:'left',valign:'top',margin:0 });
      if(s.quoteAuthor) sl.addText('‚Äî '+s.quoteAuthor, { x:0.65,y:4.35,w:8,h:0.6, fontSize:14,color:'f0c040',fontFace:'Calibri',bold:true,margin:0 });

    } else if (s.type === 'timeline') {
      sl.background = { color: T.slide };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.82, fill:{color:T.title_bg}, line:{color:T.title_bg} });
      sl.addShape(pres.ShapeType.rect, { x:0,y:0.82,w:W,h:0.035, fill:{color:T.accent}, line:{color:T.accent} });
      sl.addText(s.title, { x:0.5,y:0.1,w:9,h:0.65, fontSize:21,bold:true,color:'FFFFFF',fontFace:'Calibri',margin:0 });
      sl.addShape(pres.ShapeType.rect, { x:0.5,y:2.62,w:9,h:0.04, fill:{color:T.accent}, line:{color:T.accent} });
      const tl=(s.timelineItems||[]).slice(0,5); const cw=9/Math.max(tl.length,1);
      tl.forEach((item,j)=>{ const cx=0.5+j*cw+cw/2-0.1; sl.addShape(pres.ShapeType.ellipse,{x:cx-0.1,y:2.53,w:0.18,h:0.18,fill:{color:'f0c040'},line:{color:'f0c040'}}); sl.addText(item.year||'',{x:cx-cw/2,y:1.88,w:cw,h:0.55,fontSize:14,bold:true,color:'f0c040',fontFace:'Calibri',align:'center',margin:0}); sl.addText(item.event||'',{x:cx-cw/2,y:2.84,w:cw,h:2.0,fontSize:11,color:drk?'D8E8FF':T.text,fontFace:'Calibri',align:'center',valign:'top',margin:0}); });

    } else if (s.type === 'closing') {
      sl.background = { color: T.title_bg };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.2, fill:{color:'f0c040'}, line:{color:'f0c040'} });
      sl.addShape(pres.ShapeType.rect, { x:0,y:H-0.2,w:W,h:0.2, fill:{color:'f0c040'}, line:{color:'f0c040'} });
      sl.addText(s.title||'–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ', { x:0.5,y:1.45,w:9,h:1.5, fontSize:34,bold:true,color:'FFFFFF',fontFace:'Calibri',align:'center',valign:'middle',margin:0 });
      if(s.body) sl.addText(s.body, { x:1,y:3.1,w:8,h:0.9, fontSize:16,color:'f0c040',fontFace:'Calibri',align:'center',margin:0 });
    } else {
      sl.background = { color: T.slide };
      sl.addShape(pres.ShapeType.rect, { x:0,y:0,w:W,h:0.82, fill:{color:T.title_bg}, line:{color:T.title_bg} });
      sl.addText(s.title||'', { x:0.5,y:0.1,w:9,h:0.65, fontSize:21,bold:true,color:'FFFFFF',fontFace:'Calibri',margin:0 });
      const txt=s.body||(s.bullets?s.bullets.join('\n'):'');
      if(txt) sl.addText(txt,{x:0.5,y:1.1,w:9,h:4.1,fontSize:14,color:drk?'D8E8FF':T.text,fontFace:'Calibri',valign:'top',margin:0});
    }

    if(s.speakerNotes) sl.addNotes(s.speakerNotes);
    if(s.type!=='title') sl.addText(String(i+1),{x:9.55,y:5.22,w:0.35,h:0.28,fontSize:9,color:T.muted,align:'right',margin:0});
  }
  return pres;
}
async function generate() {
  const topic    = document.getElementById('topic').value.trim();
  const audience = document.getElementById('audience').value.trim();
  const reqs     = document.getElementById('requirements').value.trim();
  const lang     = document.getElementById('language').value;
  const nSlides  = parseInt(document.getElementById('slidesCount').value);
  const apiUrl   = document.getElementById('apiUrl').value.trim();

  if (!topic)  { toast('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏'); return; }
  if (!apiUrl) { toast('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ URL API'); return; }

  document.getElementById('resultCard').classList.remove('open');
  document.getElementById('statusCard').classList.add('open');
  document.getElementById('genBtn').disabled = true;
  logLines = []; document.getElementById('logbox').innerHTML = '';
  progress(5);

  const opts = { topic, audience, requirements: reqs, language: lang, tone: selTone, slides: nSlides };

  try {
    log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ' + apiUrl.replace('http://','') + '‚Ä¶');
    progress(12);

    const sysPrompt = buildPrompt(opts);
    const userMsg   = `–°–æ–∑–¥–∞–π –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é: "${topic}". –°–ª–∞–π–¥–æ–≤: ${nSlides}. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON-–º–∞—Å—Å–∏–≤.`;

    progress(22);
    log('–ó–∞–ø—Ä–æ—Å –∫ GPT-OSS-120B‚Ä¶');

    const resp = await fetch(apiUrl, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({
        model: 'GPT-OSS-120B',
        messages: [ { role:'system', content: sysPrompt }, { role:'user', content: userMsg } ],
        temperature: parseFloat(document.getElementById('tempRange').value),
        max_tokens: parseInt(document.getElementById('maxTokens').value) || 8000,
        stream: false
      })
    });

    if (!resp.ok) {
      let e=''; try { const j=await resp.json(); e=j.detail||j.message||JSON.stringify(j); } catch { e=await resp.text().catch(()=>''); }
      throw new Error(`HTTP ${resp.status}: ${e.slice(0,200)}`);
    }

    progress(55);
    log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, –ø–∞—Ä—Å–∏–º JSON‚Ä¶');

    const data = await resp.json();
    let raw = parseResp(data).replace(/```json\s*/gi,'').replace(/```\s*/g,'').trim();

    let slides;
    try { slides = JSON.parse(raw); if(!Array.isArray(slides)) throw new Error('–Ω–µ –º–∞—Å—Å–∏–≤'); }
    catch { const m=raw.match(/\[[\s\S]*\]/); if(m) slides=JSON.parse(m[0]); else throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:\n'+raw.slice(0,300)); }

    if (!slides.length) throw new Error('–ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤');

    log(`${slides.length} —Å–ª–∞–π–¥–æ–≤ ‚Äî —Å—Ç—Ä–æ–∏–º PPTX‚Ä¶`);
    progress(70);

    const pres = await buildPptx(slides, opts);
    progress(90);
    log('–î–∏–∑–∞–π–Ω –í–®–ë –ø—Ä–∏–º–µ–Ω—ë–Ω ‚úì');

    const fname = topic.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9 ]/g,'').trim().slice(0,48) + '.pptx';
    const buf   = await pres.write({ outputType: 'arraybuffer' });
    pptxBlob = new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.presentationml.presentation' });

    progress(100);
    log('–ì–æ—Ç–æ–≤–æ! üéâ', 'done');

    document.getElementById('connDot').className   = 'dot on';
    document.getElementById('connLabel').textContent = '—É—Å–ø–µ—à–Ω–æ';

    setTimeout(() => {
      document.getElementById('statusCard').classList.remove('open');
      document.getElementById('resultCard').classList.add('open');
      document.getElementById('resTitle').textContent = `–ì–æ—Ç–æ–≤–æ ‚Äî ${slides.length} —Å–ª–∞–π–¥–æ–≤`;
      document.getElementById('resMeta').textContent  = `${slides.length} —Å–ª–∞–π–¥–æ–≤ ¬∑ PPTX ¬∑ ${topic.slice(0,50)}`;

      const T = THEMES[selTheme];
      const thumbsEl = document.getElementById('thumbs');
      thumbsEl.innerHTML = '';
      slides.forEach((s,i) => {
        const d = document.createElement('div');
        d.className = 'thumb';
        d.style.background = '#'+T.slide;
        d.innerHTML = `<div style="background:#${T.title_bg};color:#fff;width:100%;padding:2px 4px;font-size:5.5px;font-weight:bold">${i+1}. ${(s.title||'').slice(0,16)}</div><div style="padding:2px 4px;font-size:5.5px;color:#${T.muted}">${s.type}</div>`;
        thumbsEl.appendChild(d);
      });

      document.getElementById('dlBtn').onclick = () => {
        const url = URL.createObjectURL(pptxBlob);
        const a = document.createElement('a');
        a.href = url; a.download = fname; a.click();
        setTimeout(() => URL.revokeObjectURL(url), 3000);
      };
    }, 350);

  } catch(err) {
    progress(0);
    log('–û—à–∏–±–∫–∞: ' + err.message, 'err');
    toast('‚ùå ' + err.message);
    document.getElementById('genBtn').disabled = false;
    document.getElementById('genBtnText').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É';
  }
}

function doReset() {
  document.getElementById('resultCard').classList.remove('open');
  document.getElementById('statusCard').classList.remove('open');
  document.getElementById('genBtn').disabled = false;
  document.getElementById('genBtnText').textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é';
  logLines = []; document.getElementById('logbox').innerHTML = '';
  pptxBlob = null; progress(0);
  document.getElementById('topic').value = '';
  document.getElementById('audience').value = '';
  document.getElementById('requirements').value = '';
}
(function () {
  const overlay = document.getElementById('genOverlay');
  const btnClose = document.getElementById('genOverlayClose');
  if (btnClose) btnClose.onclick = () => overlay && (overlay.style.display = 'none');

  function showOverlay() { if (overlay) overlay.style.display = 'flex'; }
  function hideOverlay() { if (overlay) overlay.style.display = 'none'; }
  const realFetch = window.fetch.bind(window);
  function buildBackendPayload() {
    const topic = document.getElementById('topic')?.value?.trim() || '';
    const audience = document.getElementById('audience')?.value?.trim() || '';
    const requirements = document.getElementById('requirements')?.value?.trim() || '';
    const slides = parseInt(document.getElementById('slidesCount')?.value || '10', 10);
    const styleMap = { professional: 'business', minimalist: 'minimal', friendly: 'fun' };
    const style = styleMap[window.selTone] || 'business';
    const theme = (window.selTheme === 'hse_light') ? 'light' : 'dark';
    const text = [
      `–¢–ï–ú–ê: ${topic}`,
      audience ? `–ê–£–î–ò–¢–û–†–ò–Ø: ${audience}` : '',
      requirements ? `–¢–†–ï–ë–û–í–ê–ù–ò–Ø: ${requirements}` : ''
    ].filter(Boolean).join('\n');

    return { text, style, theme, slides };
  }

  let hijack = false;
  window.fetch = async function (url, options = {}) {
    if (!hijack) return realFetch(url, options);
    try {
      const payload = buildBackendPayload();
      console.log('[PrezAI] request payload:', payload);

      showOverlay();

      const resp = await realFetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const t = await resp.text().catch(() => '');
        throw new Error(`Backend /api/chat HTTP ${resp.status}: ${t.slice(0,200)}`);
      }

      const blob = await resp.blob();
      window.pptxBlob = blob;
      const fakeSlides = [
        { type: "title", title: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞", subtitle: "–§–∞–π–ª –ø—Ä–∏—à—ë–ª —Å backend", speakerNotes: "PPTX –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ /api/chat" },
        { type: "closing", title: "–ì–æ—Ç–æ–≤–æ", body: "–°–∫–∞—á–∞–π PPTX –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ", speakerNotes: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è blob –æ—Ç backend" }
      ];
      const fake = { choices: [{ message: { content: JSON.stringify(fakeSlides) } }] };
      return new Response(JSON.stringify(fake), { status: 200, headers: { 'Content-Type': 'application/json' } });
    } catch (e) {
      hideOverlay();
      throw e;
    }
  };
  const origGenerate = window.generate;
  if (typeof origGenerate === 'function') {
    window.generate = async function () {
      hijack = true;
      try {
        const r = await origGenerate();
        if (window.pptxBlob) {
          const dlBtn = document.getElementById('dlBtn');
          const topic = document.getElementById('topic')?.value?.trim() || 'presentation';
          const fname = (topic.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9 ]/g,'').trim().slice(0,48) || 'presentation') + '.pptx';
          if (dlBtn) {
            dlBtn.onclick = () => {
              const url = URL.createObjectURL(window.pptxBlob);
              const a = document.createElement('a');
              a.href = url;
              a.download = fname;
              a.click();
              setTimeout(() => URL.revokeObjectURL(url), 3000);
            };
          }
        }
        return r;
      } finally {
        hijack = false;
        hideOverlay();
      }
    };
  }
})();
</script>
</body>
</html>
